services:
  usuarios-ms:
    build: ./UsuariosMsAuto
    ports: ["3000:4001"]
    depends_on: [usuarios-db]
    networks: [microservices-net]

  usuarios-db:
    image: mysql:8.0.36
    environment:
      MYSQL_ROOT_PASSWORD: root
    networks:
      - microservices-net
    volumes:
      - mysql-usuarios-data:/var/lib/mysql  # Persistencia de datos
      - ./UsuariosMsAuto/init.sql:/docker-entrypoint-initdb.d/init.sql 

  vehiculos-queries-db:
    image: mongo:7.0.5
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: vehiculosdbauto_read
    networks:
      - microservices-net
    volumes:
      - mongo-vehiculos-data:/data/db  # Persistencia de datos MongoDB

  vehiculos-queries-ms:
    build: ./VehiculosMsAuto_Queries
    ports: ["3001:4005"]
    depends_on: [vehiculos-queries-db]
    networks: [microservices-net]

  vehiculos-commands-ms:
    build:
      context: ./VehiculosMsAuto_Commands
      dockerfile: Dockerfile
    ports:
      - "3002:4006"
    environment:
      DB_HOST: vehiculos-commands-db
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: vehiculosdbauto_write
      KAFKA_BROKERS: kafka:29092
    depends_on:
      - vehiculos-commands-db
      - kafka
    networks:
      - microservices-net

  vehiculos-commands-db:
    image: mysql:8.0.36
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_SECURE_FILE_PRIV: ""
    command:
      --secure-file-priv=/tmp/
      --server-id=223344
      --log-bin=mysql-bin
      --binlog-format=ROW
      --gtid-mode=ON
      --enforce-gtid-consistency=TRUE
    volumes:
      - mysql-vehiculos-data:/var/lib/mysql  # Persistencia de datos
      - ./VehiculosMsAuto_Commands/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - microservices-net

  contratos-ms:
    build: ./ContratosMsAuto
    ports: ["3003:4003"]
    depends_on: [contratos-db]
    networks: [microservices-net]

  contratos-db:
    image: mysql:8.0.36
    environment:
      MYSQL_ROOT_PASSWORD: root
    networks:
      - microservices-net
    volumes:
      - mysql-contratos-data:/var/lib/mysql  # Persistencia de datos
      - ./ContratosMsAuto/init.sql:/docker-entrypoint-initdb.d/init.sql

  ventas-ms:
    build: ./VentasMsAuto
    ports: ["3004:4004"]
    depends_on: [ventas-db]
    networks: [microservices-net]

  ventas-db:
    image: mysql:8.0.36
    environment:
      MYSQL_ROOT_PASSWORD: root
    networks:
      - microservices-net
    volumes:
      - mysql-ventas-data:/var/lib/mysql  # Persistencia de datos
      - ./VentasMsAuto/init.sql:/docker-entrypoint-initdb.d/init.sql

  automarketweb:
    build:
      context: ./automarketweb
      dockerfile: Dockerfile
    ports:
      - "80:80"
    networks:
      - microservices-net

  zookeeper:
    image: confluentinc/cp-zookeeper:latest-ubi8
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - microservices-net

  kafka:
    image: confluentinc/cp-kafka:latest-ubi8
    container_name: kafka-vehiculos
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-vehiculos:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - microservices-net

  kafka-connect:
    container_name: kafka-connect
    image: debezium/connect:2.7.3.Final
    ports:
      - "8083:8083"
    environment:
      GROUP_ID: 1
      ADVERTISED_HOST_NAME: kafka-connect
      BOOTSTRAP_SERVERS: kafka:29092
      CONFIG_STORAGE_TOPIC: connect-configs
      OFFSET_STORAGE_TOPIC: connect-offsets
      STATUS_STORAGE_TOPIC: connect-status
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_PLUGIN_PATH: "/kafka/connect,/opt/kafka/plugins"
    volumes:
      - ./VehiculosMsAuto_Queries/kafka-connect:/opt/kafka/plugins
    depends_on:
      - zookeeper
      - kafka
    networks:
      - microservices-net

  kafka-ui:
    container_name: kafka-ui
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: vehiculos-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME: vehiculos-connect
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS: http://kafka-connect:8083
      DYNAMIC_CONFIG_ENABLED: "true"
    depends_on:
      - kafka
      - kafka-connect
    networks:
      - microservices-net

  init-connectors:
    image: curlimages/curl
    container_name: init-kafka-connectors
    depends_on:
      - kafka-connect
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      echo 'Esperando a Kafka Connect...' &&
      until curl -s http://kafka-connect:8083/connectors; do sleep 5; done &&
      sleep 10 && \
      echo 'Registrando conector MySQL...' &&
      curl -s -o /dev/null -w '%{http_code}' -X POST -H 'Content-Type: application/json' --data @/opt/kafka/configs/mysql-connector.json http://kafka-connect:8083/connectors &&
      echo 'Registrando conector Mongo Sink...' &&
      curl -s -o /dev/null -w '%{http_code}' -X POST -H 'Content-Type: application/json' --data @/opt/kafka/configs/mongo-sink-connector.json http://kafka-connect:8083/connectors
      "
    volumes:
      - ./VehiculosMsAuto_Queries/kafka-connect:/opt/kafka/configs
    networks:
      - microservices-net

networks:
  microservices-net:
    driver: bridge

volumes:
  mysql-usuarios-data:  # Volumen persistente para la base de datos de usuarios
  mysql-vehiculos-data:  # Volumen persistente para la base de datos de veh√≠culos
  mysql-contratos-data:  # Volumen persistente para la base de datos de contratos
  mysql-ventas-data:  # Volumen persistente para la base de datos de ventas
  mongo-vehiculos-data:  # Volumen persistente para MongoDB
